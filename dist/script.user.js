// ==UserScript==
// @name        yareio-polished-spectator
// @description A polished version of yareio-spectator
// @namespace   npmjs.com/rollup-plugin-userscript-metablock
// @version     0.1.1
// @author      swz
// @license     MIT
// @homepage    https://github.com/swz-gh/yareio-polished-spectator#readme
// @supportURL  https://github.com/swz-gh/yareio-polished-spectator/issues
// @icon        https://yare.io/favicon.ico
// @match       https://yare.io/d*/*
// @run-at      document-start
// @grant       none
// ==/UserScript==
var t=function(){function t(t,e){this.base=t,this.battleHud=e,this.prevBaseEnergy=0,this.economyScore=0,this.totalEconomyScore=0,this.totalEconomyEfficiency=0,this.economyScoreCount=1,this.economyEfficiency=0}return t.prototype.tick=function(){var t=this,e=this.base.energy;this.prevBaseEnergy>e&&(e+=this.base.current_spirit_cost),this.economyScore=e-this.prevBaseEnergy,this.economyEfficiency=this.economyScore/living_spirits.filter((function(e){return e.player_id==t.base.player_id&&0!=e.hp})).reduce((function(t,e){return t+e.size}),0),this.totalEconomyScore+=this.economyScore,this.totalEconomyEfficiency+=this.economyEfficiency,this.prevBaseEnergy=this.base.energy,this.economyScoreCount++},t.prototype.render=function(){var t=this;this.battleHud.ctx.fillStyle=this.base.color,this.battleHud.printText(""+this.base.player_id),this.battleHud.currentLineYPos+=6;var e=living_spirits.filter((function(e){return e.player_id==t.base.player_id&&0!=e.hp})),i=living_spirits.filter((function(e){return e.player_id==t.base.player_id&&0==e.hp})).length,n=e.length,r=e.reduce((function(t,e){return t+e.energy}),0),s=e.reduce((function(t,e){return t+e.energy_capacity}),0);this.battleHud.printText("Unit Count: "+Math.trunc(n)),this.battleHud.printText("Dead Units: "+Math.trunc(i)),this.battleHud.printText("Energy: "+Math.trunc(r)),this.battleHud.printText("Energy Capacity: "+Math.trunc(s)),this.battleHud.printText("Economy Score (energy/s): "+Math.trunc(this.economyScore)),this.battleHud.printText("Avg Economy Score (energy/s): "+Math.trunc(this.totalEconomyScore/this.economyScoreCount)),this.battleHud.printText("Economic Efficiency: "+this.economyEfficiency.toFixed(2)),this.battleHud.printText("Avg Economic Efficiency: "+(this.totalEconomyEfficiency/this.economyScoreCount).toFixed(2)),this.battleHud.currentLineYPos+=24},t}(),e=function(){function t(t){this.graphIndex=0,this.graphData=[],this.lastTData=null,this.battleHud=t}return t.prototype.buildGraphData=function(){var t=window,e=Object.entries(t.game_blocks);this.lastTData!=t.active_block&&(this.graphData=e.map((function(e){return{tick:parseInt(e[0].substr(1)),values:[Object.values(e[1].p1).reduce((function(t,e){return e[3]?t+e[1]:t}),0)*("squares"==t.shapes.shape1?.56:1),Object.values(e[1].p2).reduce((function(t,e){return e[3]?t+e[1]:t}),0)*("squares"==t.shapes.shape2?.56:1)]}})).sort((function(t,e){return e.tick-t.tick})),this.lastTData=t.active_block),this.graphIndex++},t.prototype.drawGraph=function(t,e){var i=this;if(this.graphData.length>0){this.battleHud.ctx.strokeStyle=e,this.battleHud.ctx.beginPath();var n=this.battleHud.hud.width;this.battleHud.ctx.moveTo(--n,this.battleHud.hud.height-80-this.graphData[0].values[t]),console.log(this.graphData),this.graphData.forEach((function(e){i.battleHud.ctx.lineTo(--n,i.battleHud.hud.height-80-e.values[t])})),this.battleHud.ctx.stroke()}},t}(),i=new(function(){function i(){var i=this;this.selecting=!1,this.selectionStart=[0,0],this.currentLineYPos=0,this.currentLineXPos=0;var n=document.createElement("canvas");n.setAttribute("style","z-index:-2"),n.setAttribute("width",""+window.innerWidth),n.setAttribute("height",""+window.innerHeight),document.body.appendChild(n),this.hud=n,this.ctx=this.hud.getContext("2d"),this.basesHud=[],bases.forEach((function(e){i.basesHud.push(new t(e,i))})),this.unitGraph=new e(this)}return i.prototype.render=function(){var t=this;this.ctx.clearRect(0,0,this.hud.width,this.hud.height),this.ctx.fillStyle="rgba(0, 255, 0, 0.7)",this.currentLineYPos=100,this.currentLineXPos=this.hud.width-50,this.printText("Total unit count: "+living_spirits.filter((function(t){return 0!=t.hp})).length),this.currentLineYPos+=20,this.basesHud.forEach((function(e,i){e.render(),t.unitGraph.drawGraph(i,e.base.color)}))},i.prototype.tick=function(){this.basesHud.forEach((function(t){t.tick()})),this.unitGraph.buildGraphData()},i.prototype.drawText=function(t,e,i){this.ctx.font="16px Arial",this.ctx.fillText(t,e,i)},i.prototype.printText=function(t){var e=this.ctx.measureText(t).width,i=this.currentLineXPos;i=this.hud.width-e-(this.hud.width-i),this.drawText(t,i,this.currentLineYPos),this.currentLineYPos+=20},i}());setTimeout((function(){return function(){var t;console.log("ready"),null==t&&null!=render_state&&(t=render_state,render_state=function(i){t(i),e()});function e(){i.render()}function n(){i.tick()}setInterval((function(){n()}),1e3)}()}),3e3);
